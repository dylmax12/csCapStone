ARR .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
 .INT 0
ARRLOCK .INT -1
PR1 .BYT 'F'
 .BYT 'i'
 .BYT 'b'
 .BYT 'o'
 .BYT 'n'
 .BYT 'a'
 .BYT 'c'
 .BYT 'c'
 .BYT 'i'
 .BYT 32
 .BYT 'o'
 .BYT 'f'
 .BYT 32
 .BYT '/'
PR2 .BYT 32
 .BYT 'i'
 .BYT 's'
 .BYT 32
 .BYT '/'
BS .BYT '/'
NL .BYT 10
COMMA .BYT 32
SPACE .BYT 32
COUNT .INT 0
ZERO .INT 0
ONE .INT 1
BYTE .INT 4
LOOPLOCK .INT -1
TRP 2
MOV R2 R3
WHILE1 LDR R1 ZERO
CMP R1 R2
BRZ R1 DONE
LDA R1 ARR
LDR R0 COUNT
LDR R7 BYTE
MUL R0 R7
ADD R1 R0
STR R2 R1
LDA R4 PR1
PRINT1 LDB R3 R4
LDB R2 BS
CMP R2 R3
BRZ R2 NEXT
TRP 3
ADI R4 1
JMP PRINT1
NEXT LDA R4 ARR
LDR R5 COUNT
LDR R7 BYTE
MUL R5 R7
ADD R4 R5
LDR R3 R4
TRP 1
LDA R4 PR2
PRINT2 LDB R3 R4
LDB R2 BS
CMP R2 R3
BRZ R2 JUMPING
TRP 3
ADI R4 1
JMP PRINT2
JUMPING LDR R6 COUNT
ADI R6 1
STR R6 COUNT
MOV R5 SP
ADI R5 -24
CMP R5 SL
BLT R5 OVERFLOW
MOV R3 FP
MOV FP SP
ADI SP -4
STR R3 SP
ADI SP -4
LDA R0 ARR
LDR R1 COUNT
ADI R1 -1
LDR R7 BYTE
MUL R1 R7
ADD R0 R1
LDR R2 R0
STR R2 SP
ADI SP -16
MOV R1 PC
ADI R1 48
STR R1 FP
JMP FIB
LDR R0 SP
LDA R1 ARR
LDR R2 COUNT
LDR R7 BYTE
MUL R2 R7
ADD R1 R2
STR R0 R1
MOV R3 R0
TRP 1
LDB R3 NL
TRP 3
LDR R2 COUNT
ADI R2 1
STR R2 COUNT
TRP 2
MOV R2 R3
JMP WHILE1
DONE LDA R4 ARR
LDA R5 ARR
LDR R0 COUNT
LDR R1 ZERO
LDR R2 BYTE
MUL R2 R0
MOV R0 R2
WHILE2 ADD R4 R1
ADI R0 -4
MOV R7 R0
CMP R7 R1
BLT R7 DONE2
LDR R3 R4
TRP 1
LDB R3 COMMA
TRP 3
LDB R3 SPACE
TRP 3
ADD R5 R0
LDR R3 R5
TRP 1
LDB R3 COMMA
TRP 3
LDB R3 SPACE
TRP 3
ADI R1 4
LDA R4 ARR
LDA R5 ARR
JMP WHILE2 
DONE2 LDB R3 NL
TRP 3
LCK LOOPLOCK
LDR R0 ZERO
STR R0 COUNT
WHILE3 TRP 2
MOV R2 R3
LDR R1 ZERO
CMP R1 R2
BRZ R1 DONE3
RUN R7 THREAD
JMP WHILE3
DONE3 ULK LOOPLOCK
BLK
LDA R4 ARR
LDA R5 ARR
LDR R0 COUNT
LDR R1 ZERO
LDR R2 BYTE
MUL R2 R0
MOV R0 R2
WHILE4 ADD R4 R1
ADI R0 -4
MOV R7 R0
CMP R7 R1
BLT R7 DONE5
LDR R3 R4
TRP 1
LDB R3 COMMA
TRP 3
LDB R3 SPACE
TRP 3
ADD R5 R0
LDR R3 R5
TRP 1
LDB R3 COMMA
TRP 3
LDB R3 SPACE
TRP 3
ADI R1 4
LDA R4 ARR
LDA R5 ARR
JMP WHILE4
DONE5 TRP 0
THREAD LCK LOOPLOCK
ULK LOOPLOCK
MOV R5 SP
ADI R5 -24
CMP R5 SL
BLT R5 OVERFLOW
MOV R6 R2
MOV R3 FP
MOV FP SP
ADI SP -4
STR R3 SP
ADI SP -4
STR R6 SP
ADI SP -16
MOV R1 PC
ADI R1 48
STR R1 FP
JMP FIB
LCK ARRLOCK
LDA R1 ARR
LDR R0 COUNT
LDR R7 BYTE
MUL R0 R7
ADD R1 R0
STR R6 R1
ADI R1 4
LDR R0 SP
STR R0 R1
LDR R1 COUNT
ADI R1 2
STR R1 COUNT
ULK ARRLOCK
LDA R4 PR1
PRINT3 LDB R3 R4
LDB R2 BS
CMP R2 R3
BRZ R2 NEXT2
TRP 3
ADI R4 1
JMP PRINT3
NEXT2 MOV R3 R6
TRP 1
LDA R4 PR2
PRINT4 LDB R3 R4
LDB R2 BS
CMP R2 R3
BRZ R2 DONE4
TRP 3
ADI R4 1
JMP PRINT4
DONE4 MOV R3 R0
TRP 1
LDB R3 NL
TRP 3
END
FIB MOV R7 FP
ADI R7 -8
LDR R4 R7
LDR R5 ONE
CMP R5 R4
BRZ R5 RETURN1
BGT R5 RETURN1
MOV R5 SP
ADI R5 -24
CMP R5 SL
BLT R5 OVERFLOW
MOV R3 FP
MOV FP SP
ADI SP -4
STR R3 SP
ADI SP -4
ADI R4 -1
STR R4 SP
ADI SP -16
MOV R1 PC
ADI R1 48
STR R1 FP
JMP FIB
LDR R0 SP
MOV R7 FP
ADI R7 -12
STR R0 R7
MOV R5 SP
ADI R5 -24
CMP R5 SL
BLT R5 OVERFLOW
MOV R2 FP
ADI R2 -8
LDR R4 R2
MOV R3 FP
MOV FP SP
ADI SP -4
STR R3 SP
ADI SP -4
ADI R4 -2
STR R4 SP
ADI SP -16
MOV R1 PC
ADI R1 48
STR R1 FP
JMP FIB
LDR R0 SP
MOV R7 FP
ADI R7 -16
STR R0 R7
ADI R7 4
LDR R1 R7
ADD R1 R0
JMP RETURN2
RETURN1 MOV SP FP
MOV R5 SP
CMP R5 SB
BGT R5 UNDERFLOW
LDR R5 FP
ADI FP -4
LDR FP FP
STR R4 SP
JMR R5
RETURN2 MOV SP FP
MOV R5 SP
CMP R5 SB
BGT R5 UNDERFLOW
LDR R5 FP
ADI FP -4
LDR FP FP
STR R1 SP
JMR R5
UNDERFLOW LDB R3 BS
TRP 3
TRP 0
OVERFLOW LDR R3 ONE
TRP 1
TRP 0